generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model User {
  id                String             @id @default(cuid())
  name              String?
  email             String             @unique
  emailVerified     DateTime?
  image             String?
  password          String?
  role              UserRole           @default(CANDIDATE)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  accounts          Account[]
  applications      Application[]
  candidateProfile  CandidateProfile?
  companyProfile    CompanyProfile?
  interviewSessions InterviewSession[]
}

model CandidateProfile {
  id         String   @id @default(cuid())
  userId     String   @unique
  jobTitle   String?
  location   String?
  bio        String?
  resume     String?
  linkedin   String?
  github     String?
  portfolio  String?
  experience String?
  skills     String[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CompanyProfile {
  id          String      @id @default(cuid())
  userId      String      @unique
  companyName String
  companySize CompanySize
  location    String?
  bio         String?
  website     String?
  linkedin    String?
  industry    String?
  founded     Int?
  description String?
  benefits    String[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Company {
  id          String      @id @default(cuid())
  name        String      @unique
  logo        String?
  industry    String
  locations   String[]
  cultureTags String[]
  size        CompanySize
  website     String?
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  jobs        Job[]
}

model Job {
  id                   String                   @id @default(cuid())
  title                String
  type                 JobType
  location             String
  salary               String?
  description          String?
  requirements         String?
  isActive             Boolean                  @default(true)
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  companyId            String
  /// Foreign key linking to shared interview content.
  interviewContentId   String?
  /// Optional interview content assigned to this job.
  interviewContent     InterviewContent?        @relation(fields: [interviewContentId], references: [id], onDelete: SetNull)
  applications         Application[]
  company              Company                  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  scoringConfiguration ScoringConfiguration?
}

model ScoringConfiguration {
  id                               String   @id @default(cuid())
  jobId                            String   @unique
  /// Experience dimension weights (sum should equal experienceWeight)
  adaptabilityWeight               Float    @default(33.33)
  creativityWeight                 Float    @default(33.33)
  reasoningWeight                  Float    @default(33.34)
  /// Coding dimension weights (sum should equal codingWeight)
  codeQualityWeight                Float    @default(25)
  problemSolvingWeight             Float    @default(25)
  independenceWeight               Float    @default(25)
  /// Workstyle metric weights (part of coding score)
  iterationSpeedWeight             Float    @default(8.33)
  debugLoopsWeight                 Float    @default(8.33)
  aiAssistWeight                   Float    @default(8.34)
  /// Category weights (should sum to 100)
  experienceWeight                 Float    @default(50)
  codingWeight                     Float    @default(50)
  /// Workstyle benchmarks for normalization
  iterationSpeedThresholdModerate  Int      @default(5)
  iterationSpeedThresholdHigh      Int      @default(10)
  debugLoopsDepthThresholdFast     Float    @default(2)
  debugLoopsDepthThresholdModerate Float    @default(4)
  createdAt                        DateTime @default(now())
  updatedAt                        DateTime @updatedAt
  job                              Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

/// Interview script content shared across one or more jobs.
model InterviewContent {
  id                            String   @id @default(cuid())
  /// Background question presented before the coding challenge.
  backgroundQuestion            String?
  /// Coding challenge prompt shown to the candidate.
  codingPrompt                  String
  /// Starter template inserted into the coding editor.
  codingTemplate                String?
  /// Canonical answer used for evaluation/comparison.
  codingAnswer                  String?
  /// Expected visual output or behavior for iteration evaluation.
  expectedOutput                String?
  /// Timebox for answering the background question (seconds).
  backgroundQuestionTimeSeconds Int      @default(900)
  /// Timebox for completing the coding challenge (seconds).
  codingQuestionTimeSeconds     Int      @default(1800)
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt
  jobs                          Job[]
}

model Application {
  id                String             @id @default(cuid())
  status            ApplicationStatus  @default(PENDING)
  appliedAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  candidateId       String
  jobId             String
  candidate         User               @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  job               Job                @relation(fields: [jobId], references: [id], onDelete: Cascade)
  interviewSessions InterviewSession[]

  @@unique([candidateId, jobId])
}

model InterviewSession {
  id                 String                @id @default(cuid())
  candidateId        String
  applicationId      String
  videoUrl           String?
  /// Timestamp when screen recording started (for video offset calculation).
  recordingStartedAt DateTime?
  startedAt          DateTime              @default(now())
  completedAt        DateTime?
  duration           Int?
  status             String                @default("IN_PROGRESS")
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  application        Application           @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  candidate          User                  @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  telemetryData      TelemetryData?
  messages           ConversationMessage[]
  iterations         Iteration[]
  debugLoops         DebugLoop[]
  externalToolUsages ExternalToolUsage[]
}

model TelemetryData {
  id                 String             @id @default(cuid())
  interviewSessionId String             @unique
  matchScore         Int
  confidence         String
  story              String
  hasFairnessFlag    Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  // New analytics series stored as JSON arrays
  persistenceFlow    Json?
  learningToAction   Json?
  confidenceCurve    Json?
  evidenceClips      EvidenceClip[]
  gapAnalysis        GapAnalysis?
  interviewSession   InterviewSession   @relation(fields: [interviewSessionId], references: [id], onDelete: Cascade)
  videoChapters      VideoChapter[]
  workstyleMetrics   WorkstyleMetrics?
  backgroundSummary  BackgroundSummary?
  codingSummary      CodingSummary?
}

model WorkstyleMetrics {
  id                String        @id @default(cuid())
  telemetryDataId   String        @unique
  iterationSpeed    Int?
  debugLoops        Int?
  refactorCleanups  Int?
  aiAssistUsage     Int?
  externalToolUsage Int?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  telemetryData     TelemetryData @relation(fields: [telemetryDataId], references: [id], onDelete: Cascade)
}

model GapAnalysis {
  id              String        @id @default(cuid())
  telemetryDataId String        @unique
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  gaps            Gap[]         @relation("GapAnalysisGaps")
  telemetryData   TelemetryData @relation(fields: [telemetryDataId], references: [id], onDelete: Cascade)
}

model Gap {
  id            String      @id @default(cuid())
  gapAnalysisId String
  severity      String
  description   String
  color         String
  evidenceLinks Int[]
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  gapAnalysis   GapAnalysis @relation("GapAnalysisGaps", fields: [gapAnalysisId], references: [id], onDelete: Cascade)
}

model EvidenceClip {
  id              String            @id @default(cuid())
  telemetryDataId String
  title           String
  thumbnailUrl    String?
  duration        Int
  description     String
  startTime       Int?
  category        EvidenceCategory?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  telemetryData   TelemetryData     @relation(fields: [telemetryDataId], references: [id], onDelete: Cascade)
}

model VideoChapter {
  id              String         @id @default(cuid())
  telemetryDataId String
  title           String
  startTime       Int
  endTime         Int
  description     String
  thumbnailUrl    String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  captions        VideoCaption[] @relation("VideoChapterCaptions")
  telemetryData   TelemetryData  @relation(fields: [telemetryDataId], references: [id], onDelete: Cascade)
}

model VideoCaption {
  id             String       @id @default(cuid())
  videoChapterId String
  text           String
  startTime      Int
  endTime        Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  videoChapter   VideoChapter @relation("VideoChapterCaptions", fields: [videoChapterId], references: [id], onDelete: Cascade)
}

model ConversationMessage {
  id                 String           @id @default(cuid())
  interviewSessionId String
  speaker            String
  text               String
  stage              String
  timestamp          DateTime
  createdAt          DateTime         @default(now())
  interviewSession   InterviewSession @relation(fields: [interviewSessionId], references: [id], onDelete: Cascade)

  @@index([interviewSessionId, timestamp])
}

model BackgroundSummary {
  id                String        @id @default(cuid())
  telemetryDataId   String        @unique
  executiveSummary  String
  recommendation    String?
  adaptabilityScore Int
  adaptabilityText  String
  creativityScore   Int
  creativityText    String
  reasoningScore    Int
  reasoningText     String
  conversationJson  Json
  evidenceJson      Json
  generatedAt       DateTime      @default(now())
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  telemetryData     TelemetryData @relation(fields: [telemetryDataId], references: [id], onDelete: Cascade)
}

model CodingSummary {
  id                  String        @id @default(cuid())
  telemetryDataId     String        @unique
  executiveSummary    String
  recommendation      String?
  codeQualityScore    Int
  codeQualityText     String
  problemSolvingScore Int
  problemSolvingText  String
  independenceScore   Int
  independenceText    String
  generatedAt         DateTime      @default(now())
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  telemetryData       TelemetryData @relation(fields: [telemetryDataId], references: [id], onDelete: Cascade)
}

enum UserRole {
  CANDIDATE
  COMPANY
  ADMIN
}

enum CompanySize {
  STARTUP
  SMALL
  MEDIUM
  LARGE
  ENTERPRISE
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
}

/// Tracks each code run iteration during the coding stage.
model Iteration {
  id                 String           @id @default(cuid())
  interviewSessionId String
  /// Absolute timestamp when Run button was clicked.
  timestamp          DateTime         @default(now())
  /// Full code snapshot at time of run.
  codeSnapshot       String
  /// Captured output from preview (text, description, or error message).
  actualOutput       String
  /// Expected output from interview script.
  expectedOutput     String
  /// OpenAI evaluation result.
  evaluation         IterationResult
  /// OpenAI reasoning for evaluation.
  reasoning          String
  /// Match percentage (0-100).
  matchPercentage    Int
  /// Caption for video evidence.
  caption            String
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  interviewSession   InterviewSession @relation(fields: [interviewSessionId], references: [id], onDelete: Cascade)

  @@index([interviewSessionId])
}

model DebugLoop {
  id                 String           @id @default(cuid())
  interviewSessionId String
  /// Timestamp when the debug loop started (first error).
  startTimestamp     DateTime
  /// Timestamp when the loop ended (first success after errors).
  endTimestamp       DateTime
  /// Number of consecutive errors before resolution.
  errorCount         Int
  /// Whether the loop was resolved (true) or still failing (false).
  resolved           Boolean
  /// Caption for video evidence.
  caption            String
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  interviewSession   InterviewSession @relation(fields: [interviewSessionId], references: [id], onDelete: Cascade)

  @@index([interviewSessionId])
}

/// Tracks external tool usage (pasted code from AI, Stack Overflow, etc.).
model ExternalToolUsage {
  id                    String            @id @default(cuid())
  interviewSessionId    String
  /// Timestamp when paste occurred.
  timestamp             DateTime          @default(now())
  /// Content that was pasted.
  pastedContent         String
  /// Character count of paste.
  characterCount        Int
  /// AI's followup question about the pasted code.
  aiQuestion            String
  /// Timestamp when AI asked the question.
  aiQuestionTimestamp   DateTime
  /// User's answer to AI's question.
  userAnswer            String
  /// Timestamp when user answered.
  userAnswerTimestamp   DateTime
  /// OpenAI evaluation of understanding.
  understanding         UnderstandingLevel
  /// Accountability score (0-100).
  accountabilityScore   Int
  /// OpenAI reasoning for evaluation.
  reasoning             String
  /// Caption for video evidence.
  caption               String
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  interviewSession      InterviewSession  @relation(fields: [interviewSessionId], references: [id], onDelete: Cascade)

  @@index([interviewSessionId])
}

enum IterationResult {
  CORRECT
  PARTIAL
  INCORRECT
}

enum UnderstandingLevel {
  FULL
  PARTIAL
  NONE
}

enum ApplicationStatus {
  PENDING
  REVIEWED
  INTERVIEWING
  ACCEPTED
  REJECTED
}

enum EvidenceCategory {
  ITERATION_SPEED
  DEBUG_LOOP
  REFACTOR_CLEANUPS
  AI_ASSIST_USAGE
  EXTERNAL_TOOL_USAGE
}
